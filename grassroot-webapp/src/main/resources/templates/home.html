<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" xmlns:data="http://www.w3.org/1999/xhtml"
      data-layout-decorate="~{layout}">
<head>

  <title>Home</title>

  <meta property="og:title" content="grassroot.org.za"/>
  <meta property="og:image" content="/img/horizontal-logo.png"/>
  <meta property="og:description" content="The Grassroot Platform"/>

  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

</head>

<body>

<section layout:fragment="header" class="top-container">
  <div class="container">
    <div class="row">
      <div class="col-md-6 col-md-offset-3 col-sm-8 col-sm-offset-2 col-xs-12">
        <h2 th:text="#{web.home.banner}" class="text-center header-content-title">Meet, vote act</h2>
        <h4 th:text="#{web.home.welcome(${currentUser.displayName})}" class="text-center header-content-subtitle">Welcome back to Grassroot, Luke</h4>
      </div>
    </div>
  </div>
</section>

<div layout:fragment="content">

  <section class="grassroot-form">
    <div class="container">
      <div class="row">
        <div class="col-md-10 col-md-offset-1">
          <form th:action="@{/group/search}" method="get" class="form-vertical">
            <div class="input-group input-group-lg">
              <input type="text" name="term" class="form-control" id="searchTerm" />
              <span class="input-group-btn">
                <button type="submit" class="btn btn-primary"><i class="fa fa-search" aria-hidden="true"></i>Search</button>
              </span>
            </div>
          </form>
        </div>
      </div>
    </div>
  </section>


  <section class="join-requests" th:if="${not #lists.isEmpty(joinRequestsPending)}">
    <div class="container">
      <div class="row">
        <div class="col-md-10 col-md-offset-1">
          <div class="panel-group">
            <div class="panel panel-default">
              <div class="panel-heading">
                <h4 class="panel-title">
                  <a data-toggle="collapse" href="#collapse0">
                    Pending join requests<i class="fa fa-caret-down" aria-hidden="true"></i></a>
                </h4>
              </div>
              <div class="panel-collapse collapse in" id="collapse0">
                <ul class="list-group">
                  <li th:each="request : ${joinRequestsPending}" class="list-group-item" >
                    <div class="row">
                      <div class="col-md-8 event-item">
                        <p class="list-item-no-header">
                          <span th:text="${request.requestor.getName('')}">Name</span> has asked to join "<span th:text="${request.group.getName('')}">group name</span>"
                        </p>
                      </div>
                      <div class="col-md-4 button-md-align response-buttons">
                        <a th:href="@{/group/join/approve(requestUid=${request.uid})}" class="btn btn-positive">Approve</a>
                        <a th:href="@{/group/join/decline(requestUid=${request.uid})}" class="btn btn-negative">Reject</a>
                        <button type="button" class="btn btn-default" data-toggle="modal" data-target="#joinReqDetailsModal" data:name="${request.requestor.getName('')}"
                           data:description="${request.description}" data:uid="${request.uid}" data:phone="${request.requestor.phoneNumber}" >
                          Details</button>
                      </div>
                    </div>
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <div th:if="${not #lists.isEmpty(joinRequestsPending)}" class="modal fade" id="joinReqDetailsModal"
       tabindex="-1" role="dialog" aria-labelledby="joinModalLabel">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title" id="joinModalLabel">
            Join request details
          </h4>
        </div>
        <div class="modal-body">
          <div class="row padding-sm">
            <div class="col-md-4"><b>Requestor's name:</b></div><div class="col-md-8"><span id="requestorName">Person</span></div>
          </div>
          <div class="row padding-sm">
            <div class="col-md-4"><b>Their phone number:</b></div><div class="col-md-8"><span id="requestorPhone">Person</span></div>
          </div>
          <div class="row padding-sm">
            <div class="col-md-4"><b>Message from them:</b></div><div class="col-md-8"><span id="requestDescription">Description</span></div>
          </div>
        </div>
        <div class="modal-footer">
          <a th:href="@{/group/join/approve}" id="approveLink">
            <button class="btn btn-default btn-lg" type="submit">Approve</button></a>
          <a th:href="@{/group/join/decline}" id="declineLink">
            <button class="btn btn-default btn-lg" type="submit">Reject</button></a>
        </div>
      </div>
    </div>
  </div>

  <section class="upcoming-events" th:if="${not #lists.isEmpty(upcomingTasks)}">
    <div class="container">
    <div class="row">
      <div class="col-md-10 col-md-offset-1">
        <h4 class="section-subtitle text-center">Upcoming events and actions</h4>

        <div class="panel-group">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h4 class="panel-title">
                <a data-toggle="collapse" href="#collapse1" class="panel-title-text">
                  List of events and actions
                  <i class="fa fa-caret-down" aria-hidden="true"></i>
                </a>
              </h4>
            </div>

            <div id="collapse1" class="panel-collapse collapse in">
              <ul class="list-group">
                <li th:each="task, iterStat : ${upcomingTasks}" class="list-group-item">
                  <div class="row">
                    <!-- LHS: Description of task -->
                    <div class="col-md-8 event-item">
                      <a class="list-header" href="#" th:href="'javascript:fetchTaskDescription(\'' + ${task.taskUid} + '\', \'' + ${task.type} + '\')'">
                        <span th:text="${task.type}">Meeting</span>: <span th:text="${task.title}">Title</span></a>
                      <p class="list-group-text" th:text="#{web.home.__${task.type}__.description(${task.parentName},
                      ${#temporals.format(task.getDeadlineDateTime(),'h:mm a, dd MMMM')})}">Description</p>
                    </div>

                    <!-- RHS: Actions on task -->
                    <div class="col-md-4 button-md-align response-buttons">

                      <div th:unless="${task.hasResponded}">
                        <div th:switch="${task.type}">
                          <div th:case="MEETING">
                            <a class="btn btn-positive" th:href="@{meeting/rsvp(eventUid=${task.taskUid},answer=yes)}">
                              I'll attend
                            </a>
                            <a class="btn btn-negative" th:href="@{meeting/rsvp(eventUid=${task.taskUid},answer=no)}">
                              I can't make it
                            </a>
                          </div>
                          <div th:case="VOTE">
                            <a th:href="@{vote/answer(eventUid=${task.taskUid},answer=yes)}" class="btn btn-positive">Vote yes</a>
                            <a th:href="@{vote/answer(eventUid=${task.taskUid},answer=no)}" class="btn btn-negative">Vote no</a>
                            <a th:href="@{vote/answer(eventUid=${task.taskUid},answer=maybe)}" class="btn btn-neutral">Abstain</a>
                          </div>
                          <div th:case="TODO">
                            <a th:href="@{todo/complete(todoUid=${task.taskUid})}" class="btn btn-positive">Mark complete</a>
                          </div>
                        </div>
                      </div>

                      <div th:if="${task.hasResponded}">
                        <div th:switch="${task.type}">
                            <div th:case="MEETING">
                              <a href="#" th:href="'javascript:fetchTaskDescription(\'' + ${task.taskUid} + '\', \'' + ${task.type} + '\')'">
                                <span class="badge" th:if="${#strings.equalsIgnoreCase(task.reply, 'Yes')}">You're attending</span>
                                <span class="badge" th:if="${#strings.equalsIgnoreCase(task.reply, 'No')}">You're not attending</span>
                              </a>
                            </div>
                            <div th:case="VOTE">
                              <a href="#" th:href="'javascript:fetchTaskDescription(\'' + ${task.taskUid} + '\', \'' + ${task.type} + '\')'">
                                <span class="badge" th:text="#{web.home.vote.answer(${#strings.toLowerCase(task.reply)})}">ABC</span>
                              </a>
                            </div>
                            <div th:case="TODO">
                              <a href="#" th:href="'javascript:fetchTaskDescription(\'' + ${task.taskUid} + '\', \'' + ${task.type} + '\')'">
                                <span class="badge">You marked it complete</span>
                              </a>
                            </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  </section>

  <!-- List of user's groups -->

  <section class="home-groups" th:if="${not #lists.isEmpty(userGroups)}">
    <div class="container">
      <div class="row">
        <div class="col-md-8 col-md-offset-1 col-xs-12">
          <h4 class="list-group-item-text section-subtitle text-left">Your groups</h4>
        </div>
        <div class="col-md-2 col-xs-12 text-right">
          <a th:href="@{/group/create}" role="button" class="btn btn-primary btn-md new-group-btn">
            <i class="fa fa-plus" aria-hidden="true"></i>New group</a>
        </div>
      </div>
      <div class="row">
        <div class="col-md-10 col-md-offset-1">
          <div class="panel-group">
            <div class="panel panel-default">
              <div class="panel-heading">
                <h4 class="panel-title">
                  <a data-toggle="collapse" href="#collapse2">
                    List of groups
                    <i class="fa fa-caret-down" aria-hidden="true"></i>
                  </a>
                </h4>
              </div>
              <div id="collapse2" class="panel-collapse collapse in">
                <ul class="list-group">
                  <li th:each="group,iterStat : ${userGroups}" class="list-group-item">
                    <a class="list-header" th:href="@{/group/view(groupUid=${group.Uid})}"><span th:text="${group.getName('')}"></span></a>
                    <span class="badge">
                      <span th:text="${group.getMemberships().size()}"></span> Members
                    </span>
                    <p>Est. <span th:text="${#temporals.format(group.getCreatedDateTimeAtSAST(),'d MMM yyyy')}">13 May 2011</span></p>
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Skeleton of modal for displaying upcoming task (content filled by ajax method below) -->
  <div th:if="${not #lists.isEmpty(upcomingTasks)}" class="modal fade" id="taskModal" tabindex="-1" role="dialog" aria-labelledby="taskModalTitle">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title" id="taskModalTitle">Task title</h4>
        </div>
        <div class="modal-body">
          <p><strong>Summary: </strong><span id="taskModalInfo">Core info</span></p>
          <p id="taskDescHolder"><strong>Additional notes:</strong>
            <span id="taskModalDescription"></span></p>
        </div>
        <div class="modal-footer">
          <form id="taskModalNotRespondedForm" action="" method="get">
            <input type="hidden" name="eventUid" id="taskUid" />
            <button type="close" data-dismiss="modal" class="btn btn-default btn-lg">Close</button>
            <a href="#" id="taskModalViewDetails" class="btn btn-default btn-lg">View details</a>
            <button id="taskModalNoButton" type="submit" class="btn btn-danger btn-lg" name="answer" value="no">No</button>
            <button id="taskModalYesButton" type="submit" class="btn btn-primary btn-lg" name="answer" value="yes">Yes</button>
          </form>
        </div>
      </div>
    </div>
  </div>

</div>

<div class="header-container" layout:fragment="script-container">

  <script th:inline="javascript">

    function fetchTaskDescription(taskUid, taskType) {

      var token = $("meta[name='_csrf']").attr("content");
      var header = $("meta[name='_csrf_header']").attr("content");

      console.log("fetching task with type = " + taskType);

      var param = {};
      param["taskUid"] = taskUid;
      param["taskType"] = taskType;

      $.ajax({
        type : "GET",
        url : "/ajax/tasks/fetch",
        data :  param,
        dataType : "json",
        beforeSend : function(xhr) {
          xhr.setRequestHeader(header, token);
        },
        success : function(response) {
          populateAndDisplayTaskModal(response.data);
        },
        error : function(xhr, textStatus, errorThrown) {
          console.log("Error! : " + errorThrown);
          console.log("Status : " + xhr.status);
        }
      });

    }

    function populateAndDisplayTaskModal(task) {

      console.log("retrieved task, with description : " + JSON.stringify(task));

      var uid = task.taskUid;
      var type = task.type;
      var deadline = formatDeadline(new Date(task.deadlineAtSAST), task.type);
      var replied = task.hasResponded;
      var wholeGroup = task.wholeGroupAssigned;
      var descriptionExists = task.description != undefined && task.description != "";

      var modal = $('#taskModal');
      var summary = modal.find("#taskModalInfo");
      var replyForm = modal.find("#taskModalNotRespondedForm");
      var detailsButton = modal.find("#taskModalViewDetails");

      if (type == 'MEETING') {
        var suffix = replied ?
                "You responded that you will " + (task.reply === 'No' ? "not" : "") + " attend the meeting." :
                "Will you attend the meeting?";
        var invited = wholeGroup ? "the whole group is invited to the meeting" : task.memberCount + " members are invited";
        summary.html("Meeting of " + task.parentName + ", taking place at " + task.location + ". Meeting will be held at "
                + deadline + ", and " + invited + ". "  + suffix);
        replyForm.attr("action", "meeting/rsvp");
        replyForm.find("#taskModalYesButton").text("I'll attend").toggle(!replied);
        replyForm.find("#taskModalNoButton").text("I can't attend").toggle(!replied);
        detailsButton.attr('href', "meeting/view?eventUid=" + uid).toggle(replied);

      } else if (type == 'VOTE') {
        var suffix = replied ? "You voted " + ((typeof task.reply != 'undefined') ? task.reply.toLowerCase() : "") : "What's your vote?";
        summary.html("Vote of " + task.parentName + ", closing at " + deadline + ". " + suffix);
        replyForm.attr("action", "vote/answer");
        replyForm.find("#taskModalYesButton").text("Vote yes").toggle(!replied);
        replyForm.find("#taskModalNoButton").text("Vote no").toggle(!replied);
        detailsButton.attr('href', "vote/view?eventUid=" + uid).toggle(replied);
      } else if (type == 'TODO') {
        var suffix = replied ? ", and has been completed." : ". Is the action complete yet?";
        var assigned = wholeGroup ? "The action is assigned to the whole group" :
          "The action is assigned to " + task.memberCount + " members";
        summary.html("To-do for " + task.parentName + ", due by " + deadline + ". " + assigned + suffix);
        replyForm.attr("action", "todo/complete");
        replyForm.find("#taskUid").attr("name", "todoUid");
        replyForm.find("#taskModalYesButton").text("Mark completed").toggle(!replied);
        replyForm.find("#taskModalNoButton").hide();
        detailsButton.attr("href", "todo/details?todoUid=" + uid).show();
      }

      modal.find("#taskModalTitle").html(type + ": " + task.title);
      replyForm.find("#taskUid").val(uid);
      modal.find("#taskDescHolder").toggle(descriptionExists);
      if (descriptionExists) modal.find("#taskModalDescription").text(task.description);

      modal.modal();
    }

    // required due to javascript's incredibly limited date functionality ... replace once/if using jquery UI or other library
    function formatDeadline(date, type) {

      var weekday = new Array(7), months = new Array(12);
      weekday[0]="Sunday",weekday[1]="Monday",weekday[2]="Tuesday",weekday[3]="Wednesday",weekday[4]="Thursday",weekday[5]="Friday",weekday[6]="Saturday";
      months[0]="January",months[1]="February",months[2]="March",months[3]="April",months[4]="May",months[5]="June",months[6]="July",
              months[7]="August",months[8]="September",months[9]="October",months[10]="November",months[11]="December";

      if (type == "MEETING") {
        return pad(date.getHours()) + "h" + pad(date.getMinutes()) + " on " + weekday[date.getDay()] + ", " + pad(date.getDate()) + " "
                + months[date.getMonth()];
      } else if (type == "VOTE") {
        return pad(date.getHours()) + "h" + pad(date.getMinutes()) + ", " + pad(date.getDate()) + "-" + pad(date.getMonth() + 1) + "-" + date.getFullYear();
      } else if(type == "TODO") {
        return weekday[date.getDay()] + ", " + pad(date.getDate()) + " " + months[date.getMonth()];
      }
    }

    // again, insane language that doesn't even have a string format method, so have to hand write this ...
    function pad(str) { return ("00" + str).slice(-2); }


    $('#joinReqDetailsModal').on('show.bs.modal', function (event) {
      var button = $(event.relatedTarget);

      var group = button.data('uid');
      var approveHref = "/group/join/approve?requestUid=" + group;
      var declineHref = "/group/join/decline?requestUid=" + group;

      var name = button.data('name');
      var description = button.data('description');
      var phone = button.data('phone');

      console.log("description = " + description);
      console.log("declineHref = " + declineHref);
      console.log("name & number = " + name + ", " + phone);

      var modal = $(this);
      modal.find('#requestorName').text(name);
      modal.find('#requestorPhone').text(phone);
      modal.find('#requestDescription').text(description);
      modal.find('#approveLink').attr('href', approveHref);
      modal.find('#declineLink').attr('href', declineHref);
    });


  </script>

</div>

</body>
</html>